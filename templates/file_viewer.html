<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VS Code-like File Viewer</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --vscode-bg: #1e1e1e;
        --vscode-sidebar: #252526;
        --vscode-text: #d4d4d4;
        --vscode-border: #404040;
        --vscode-active: #37373d;
        --vscode-hover: #2a2d2e;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: var(--vscode-bg);
        color: var(--vscode-text);
        height: 100vh;
        display: flex;
      }

      .sidebar {
        width: 250px;
        background-color: var(--vscode-sidebar);
        border-right: 1px solid var(--vscode-border);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .file-explorer {
        padding: 10px;
      }

      .file-explorer-header {
        padding: 5px;
        font-size: 11px;
        text-transform: uppercase;
        font-weight: bold;
        color: #858585;
      }

      .file-tree {
        list-style: none;
      }

      .file-item {
        padding: 4px 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        border-radius: 3px;
      }

      .file-item:hover {
        background-color: var(--vscode-hover);
      }

      .file-item.active {
        background-color: var(--vscode-active);
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .tab-bar {
        background-color: var(--vscode-bg);
        border-bottom: 1px solid var(--vscode-border);
        display: flex;
        height: 35px;
      }

      .tab {
        padding: 8px 16px;
        background-color: var(--vscode-active);
        border-right: 1px solid var(--vscode-border);
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .content-area {
        flex: 1;
        overflow: auto;
        position: relative;
      }

      pre[class*="language-"] {
        margin: 0;
        padding: 20px;
        background-color: var(--vscode-bg) !important;
        min-height: 100%;
      }

      code[class*="language-"] {
        font-family: "Consolas", "Monaco", monospace;
        font-size: 14px;
        tab-size: 4;
      }

      .image-content {
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
      }

      .image-content img {
        max-width: 100%;
        height: auto;
      }

      .icon {
        width: 16px;
        height: 16px;
        fill: currentColor;
      }

      .line-numbers {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 50px;
        padding: 20px 0;
        background-color: var(--vscode-bg);
        border-right: 1px solid var(--vscode-border);
        color: #858585;
        font-family: monospace;
        font-size: 14px;
        text-align: right;
        user-select: none;
      }

      .status-bar {
        height: 22px;
        background-color: var(--vscode-active);
        border-top: 1px solid var(--vscode-border);
        display: flex;
        align-items: center;
        padding: 0 10px;
        font-size: 12px;
        color: #858585;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      ::-webkit-scrollbar-track {
        background: var(--vscode-bg);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--vscode-active);
        border-radius: 5px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--vscode-hover);
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="file-explorer">
        <div class="file-explorer-header">Explorer</div>
        <ul class="file-tree" id="fileTree">
          <!-- Files will be dynamically added here -->
        </ul>
      </div>
    </div>
    <div class="main-content">
      <div class="tab-bar">
        <div class="tab" id="currentTab">
          <span id="tabFileName">No file selected</span>
        </div>
      </div>
      <div class="content-area">
        <div id="fileContent"></div>
      </div>
      <div class="status-bar">
        <span id="fileInfo">Ready</span>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <script>
      function getUrlParameter(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        var results = regex.exec(location.search);
        return results === null
          ? ""
          : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      function addLineNumbers(content) {
        const lines = content.split("\n");
        const lineNumbers = document.createElement("div");
        lineNumbers.className = "line-numbers";
        lineNumbers.innerHTML = lines.map((_, i) => `${i + 1}`).join("\n");
        return lineNumbers;
      }

      async function loadFileContent(filePath) {
        const fileContentDiv = document.getElementById("fileContent");
        const tabFileName = document.getElementById("tabFileName");
        const fileInfo = document.getElementById("fileInfo");

        if (!filePath) {
          fileContentDiv.innerHTML =
            '<p class="error">No file path provided.</p>';
          return;
        }

        try {
          const response = await fetch(
            `/api/file_content?path=${encodeURIComponent(filePath)}`,
            {
              headers: {
                Authorization: `Bearer admin123`,
              },
            }
          );
          if (!response.ok) throw new Error("Could not load file");

          const data = await response.json();
          const fileName = filePath.split("/").pop();
          tabFileName.textContent = fileName;

          fileContentDiv.innerHTML = "";

          if (data.type === "image") {
            fileContentDiv.innerHTML = `<div class="image-content"><img src="${data.content}" alt="Image Preview"></div>`;
            fileInfo.textContent = `Image: ${fileName}`;
          } else if (data.type === "text" || data.type === "code") {
            const preElement = document.createElement("pre");
            const codeElement = document.createElement("code");
            preElement.className = "language-python";
            codeElement.textContent = data.content;
            preElement.appendChild(codeElement);
            fileContentDiv.appendChild(addLineNumbers(data.content));
            fileContentDiv.appendChild(preElement);
            Prism.highlightElement(codeElement);
            fileInfo.textContent = `${fileName} - ${
              data.content.split("\n").length
            } lines`;
          } else {
            fileContentDiv.innerHTML = `<p class="error">Unsupported file type.</p>`;
            fileInfo.textContent = "Error: Unsupported file type";
          }
        } catch (error) {
          console.error("Error loading file:", error);
          fileContentDiv.innerHTML = `<p class="error">An error occurred loading the file.</p>`;
          fileInfo.textContent = "Error loading file";
        }
      }

      async function loadFileTree() {
        try {
          const response = await fetch("/api/directories", {
            headers: {
              Authorization: "Bearer admin123",
            },
          });
          if (!response.ok) throw new Error("Failed to load directories");

          const files = await response.json();
          const fileTree = document.getElementById("fileTree");

          files.forEach((file) => {
            const li = document.createElement("li");
            li.className = "file-item";
            li.innerHTML = `
                        <svg class="icon" viewBox="0 0 16 16">
                            <path d="M1 3.5l.5-.5h13l.5.5v9l-.5.5h-13l-.5-.5v-9zm1 .5v8h12v-8H2z"/>
                        </svg>
                        ${file.name}
                    `;
            li.addEventListener("click", () => {
              document
                .querySelectorAll(".file-item")
                .forEach((item) => item.classList.remove("active"));
              li.classList.add("active");
              loadFileContent(file.path);
            });
            fileTree.appendChild(li);
          });
        } catch (error) {
          console.error("Error loading file tree:", error);
        }
      }

      // Initial load
      const initialPath = getUrlParameter("path");
      if (initialPath) {
        loadFileContent(initialPath);
      }
      loadFileTree();
    </script>
  </body>
</html>
